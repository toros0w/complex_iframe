<template>
  <article 
    draggable="true" 
    class="accordion"
    @dragstart="$emit('dragstart', $event)"
    @dragleave="$emit('dragleave', $event)"
    @dragend.prevent="$emit('dragend', $event)"
    @dragover.prevent="$emit('dragover', $event)"
    @drop.prevent="$emit('drop', $event)"
  >
    <header @click="toggleExpanded">
      <div style="cursor: move" class="floorItem__dragIcon">
        <svg
          width="8"
          height="12"
          viewBox="0 0 8 12"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M1.95829 4.83333C1.72755 4.83333 1.50199 4.90176 1.31013 5.02995C1.11827 5.15815 0.968736 5.34036 0.880434 5.55354C0.792131 5.76672 0.769028 6.0013 0.814044 6.22761C0.85906 6.45392 0.970174 6.6618 1.13334 6.82496C1.2965 6.98812 1.50438 7.09923 1.73069 7.14425C1.957 7.18927 2.19158 7.16616 2.40476 7.07786C2.61794 6.98956 2.80015 6.84002 2.92834 6.64817C3.05654 6.45631 3.12496 6.23075 3.12496 6C3.12496 5.69058 3.00204 5.39384 2.78325 5.17504C2.56446 4.95625 2.26771 4.83333 1.95829 4.83333ZM1.95829 8.91667C1.72755 8.91667 1.50199 8.98509 1.31013 9.11329C1.11827 9.24148 0.968736 9.42369 0.880434 9.63687C0.792131 9.85005 0.769028 10.0846 0.814044 10.3109C0.85906 10.5373 0.970174 10.7451 1.13334 10.9083C1.2965 11.0715 1.50438 11.1826 1.73069 11.2276C1.957 11.2726 2.19158 11.2495 2.40476 11.1612C2.61794 11.0729 2.80015 10.9234 2.92834 10.7315C3.05654 10.5396 3.12496 10.3141 3.12496 10.0833C3.12496 9.77391 3.00204 9.47717 2.78325 9.25838C2.56446 9.03958 2.26771 8.91667 1.95829 8.91667ZM6.04163 3.08333C6.27237 3.08333 6.49794 3.01491 6.68979 2.88672C6.88165 2.75852 7.03118 2.57631 7.11949 2.36313C7.20779 2.14995 7.23089 1.91537 7.18588 1.68906C7.14086 1.46275 7.02975 1.25487 6.86658 1.09171C6.70342 0.928548 6.49554 0.817434 6.26923 0.772418C6.04292 0.727402 5.80834 0.750505 5.59516 0.838808C5.38198 0.92711 5.19977 1.07664 5.07158 1.2685C4.94338 1.46036 4.87496 1.68592 4.87496 1.91667C4.87496 2.22609 4.99788 2.52283 5.21667 2.74163C5.43546 2.96042 5.73221 3.08333 6.04163 3.08333ZM1.95829 0.75C1.72755 0.75 1.50199 0.818424 1.31013 0.946619C1.11827 1.07481 0.968736 1.25702 0.880434 1.4702C0.792131 1.68338 0.769028 1.91796 0.814044 2.14427C0.85906 2.37058 0.970174 2.57846 1.13334 2.74163C1.2965 2.90479 1.50438 3.0159 1.73069 3.06092C1.957 3.10593 2.19158 3.08283 2.40476 2.99453C2.61794 2.90622 2.80015 2.75669 2.92834 2.56483C3.05654 2.37298 3.12496 2.14741 3.12496 1.91667C3.12496 1.60725 3.00204 1.3105 2.78325 1.09171C2.56446 0.872917 2.26771 0.75 1.95829 0.75ZM6.04163 8.91667C5.81088 8.91667 5.58532 8.98509 5.39346 9.11329C5.2016 9.24148 5.05207 9.42369 4.96377 9.63687C4.87546 9.85005 4.85236 10.0846 4.89738 10.3109C4.94239 10.5373 5.05351 10.7451 5.21667 10.9083C5.37983 11.0715 5.58771 11.1826 5.81402 11.2276C6.04033 11.2726 6.27491 11.2495 6.48809 11.1612C6.70127 11.0729 6.88348 10.9234 7.01167 10.7315C7.13987 10.5396 7.20829 10.3141 7.20829 10.0833C7.20829 9.77391 7.08538 9.47717 6.86658 9.25838C6.64779 9.03958 6.35105 8.91667 6.04163 8.91667ZM6.04163 4.83333C5.81088 4.83333 5.58532 4.90176 5.39346 5.02995C5.2016 5.15815 5.05207 5.34036 4.96377 5.55354C4.87546 5.76672 4.85236 6.0013 4.89738 6.22761C4.94239 6.45392 5.05351 6.6618 5.21667 6.82496C5.37983 6.98812 5.58771 7.09923 5.81402 7.14425C6.04033 7.18927 6.27491 7.16616 6.48809 7.07786C6.70127 6.98956 6.88348 6.84002 7.01167 6.64817C7.13987 6.45631 7.20829 6.23075 7.20829 6C7.20829 5.69058 7.08538 5.39384 6.86658 5.17504C6.64779 4.95625 6.35105 4.83333 6.04163 4.83333Z"
            fill="#9E9EA4"
          />
        </svg>
      </div>
      <div
        class="accordion-title grow"
        :class="{ 'blue-color': !expanded && floor.rooms.length }"
      >
        <div>
          Этаж {{ index }}
          <svg
            v-if="floor.rooms.length"
            :style="`rotate: ${expanded ? '270deg' : '90deg'};`"
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
          >
            <path
              d="M7.293 4.707 14.586 12l-7.293 7.293 1.414 1.414L17.414 12 8.707 3.293 7.293 4.707z"
            />
          </svg>
          <span v-else>(Пустой)</span>
        </div>
      </div>
      <div v-if="floor.rooms.length" class="flex">
        <div class="floorItem__alignment flex items-center">
          Выравнивание помещений на шахматке:
          <div class="flex align-items-center mx-2.5">
            <RadioButton
              v-model="floor.alignment"
              :inputId="`left-${floor.id}`"
              name="alignment"
              value="left"
              @click.stop
              @change="changeAlignment(floor, 'left')"
            />
            <label @click.stop :for="`left-${floor.id}`" class="ml-2"
              >Слева</label
            >
          </div>
          <div class="flex align-items-center">
            <RadioButton
              v-model="floor.alignment"
              :inputId="`right-${floor.id}`"
              name="alignment"
              value="right"
              @click.stop
              @change="changeAlignment(floor, 'right')"
            />
            <label @click.stop :for="`right-${floor.id}`" class="ml-2"
              >Справа</label
            >
          </div>
        </div>
        <MyButton
          @click.stop="bus.$emit('open:add-room', floor)"
          :theme="'green'"
          class="floorItem__addRoom text-sm"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 18 18"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M9 1.5C7.51664 1.5 6.0666 1.93987 4.83323 2.76398C3.59986 3.58809 2.63856 4.75943 2.07091 6.12987C1.50325 7.50032 1.35472 9.00832 1.64411 10.4632C1.9335 11.918 2.64781 13.2544 3.6967 14.3033C4.7456 15.3522 6.08197 16.0665 7.53683 16.3559C8.99168 16.6453 10.4997 16.4968 11.8701 15.9291C13.2406 15.3614 14.4119 14.4001 15.236 13.1668C16.0601 11.9334 16.5 10.4834 16.5 9C16.5 8.01509 16.306 7.03982 15.9291 6.12987C15.5522 5.21993 14.9997 4.39314 14.3033 3.6967C13.6069 3.00026 12.7801 2.44781 11.8701 2.0709C10.9602 1.69399 9.98492 1.5 9 1.5ZM9 15C7.81332 15 6.65328 14.6481 5.66658 13.9888C4.67989 13.3295 3.91085 12.3925 3.45673 11.2961C3.0026 10.1997 2.88378 8.99334 3.11529 7.82946C3.3468 6.66557 3.91825 5.59647 4.75736 4.75736C5.59648 3.91824 6.66558 3.3468 7.82946 3.11529C8.99335 2.88378 10.1997 3.0026 11.2961 3.45672C12.3925 3.91085 13.3295 4.67988 13.9888 5.66658C14.6481 6.65327 15 7.81331 15 9C15 10.5913 14.3679 12.1174 13.2426 13.2426C12.1174 14.3679 10.5913 15 9 15ZM12 8.25H9.75V6C9.75 5.80109 9.67099 5.61032 9.53033 5.46967C9.38968 5.32902 9.19892 5.25 9 5.25C8.80109 5.25 8.61033 5.32902 8.46967 5.46967C8.32902 5.61032 8.25 5.80109 8.25 6V8.25H6C5.80109 8.25 5.61033 8.32902 5.46967 8.46967C5.32902 8.61032 5.25 8.80109 5.25 9C5.25 9.19891 5.32902 9.38968 5.46967 9.53033C5.61033 9.67098 5.80109 9.75 6 9.75H8.25V12C8.25 12.1989 8.32902 12.3897 8.46967 12.5303C8.61033 12.671 8.80109 12.75 9 12.75C9.19892 12.75 9.38968 12.671 9.53033 12.5303C9.67099 12.3897 9.75 12.1989 9.75 12V9.75H12C12.1989 9.75 12.3897 9.67098 12.5303 9.53033C12.671 9.38968 12.75 9.19891 12.75 9C12.75 8.80109 12.671 8.61032 12.5303 8.46967C12.3897 8.32902 12.1989 8.25 12 8.25Z"
              fill="white"
            />
          </svg>

          Добавить помещение
        </MyButton>
        <MyButton
          @click.stop="$emit('copy-floor', floor)"
          :theme="'grey-icon'"
          class="floorItem__copy"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 18 18"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M12 15H6C5.40326 15 4.83097 14.7629 4.40901 14.341C3.98705 13.919 3.75 13.3467 3.75 12.75V5.25C3.75 5.05109 3.67098 4.86032 3.53033 4.71967C3.38968 4.57902 3.19891 4.5 3 4.5C2.80109 4.5 2.61032 4.57902 2.46967 4.71967C2.32902 4.86032 2.25 5.05109 2.25 5.25V12.75C2.25 13.7446 2.64509 14.6984 3.34835 15.4017C4.05161 16.1049 5.00544 16.5 6 16.5H12C12.1989 16.5 12.3897 16.421 12.5303 16.2803C12.671 16.1397 12.75 15.9489 12.75 15.75C12.75 15.5511 12.671 15.3603 12.5303 15.2197C12.3897 15.079 12.1989 15 12 15ZM15.75 6.705C15.7422 6.6361 15.7271 6.56822 15.705 6.5025V6.435C15.6689 6.35788 15.6208 6.287 15.5625 6.225L11.0625 1.725C11.0005 1.66666 10.9296 1.61856 10.8525 1.5825H10.785L10.545 1.5H7.5C6.90326 1.5 6.33097 1.73705 5.90901 2.15901C5.48705 2.58097 5.25 3.15326 5.25 3.75V11.25C5.25 11.8467 5.48705 12.419 5.90901 12.841C6.33097 13.2629 6.90326 13.5 7.5 13.5H13.5C14.0967 13.5 14.669 13.2629 15.091 12.841C15.5129 12.419 15.75 11.8467 15.75 11.25V6.75C15.75 6.75 15.75 6.75 15.75 6.705ZM11.25 4.0575L13.1925 6H12C11.8011 6 11.6103 5.92098 11.4697 5.78033C11.329 5.63968 11.25 5.44891 11.25 5.25V4.0575ZM14.25 11.25C14.25 11.4489 14.171 11.6397 14.0303 11.7803C13.8897 11.921 13.6989 12 13.5 12H7.5C7.30109 12 7.11032 11.921 6.96967 11.7803C6.82902 11.6397 6.75 11.4489 6.75 11.25V3.75C6.75 3.55109 6.82902 3.36032 6.96967 3.21967C7.11032 3.07902 7.30109 3 7.5 3H9.75V5.25C9.75 5.84674 9.98705 6.41903 10.409 6.84099C10.831 7.26295 11.4033 7.5 12 7.5H14.25V11.25Z"
              fill="#666666"
            />
          </svg>
        </MyButton>
        <MyButton
          @click.stop="$emit('delete-floor', $event, floor)"
          :theme="'grey-icon'"
          class="floorItem__delete"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 18 18"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M7.5 13.5C7.69891 13.5 7.88968 13.421 8.03033 13.2803C8.17098 13.1397 8.25 12.9489 8.25 12.75V8.25C8.25 8.05109 8.17098 7.86032 8.03033 7.71967C7.88968 7.57902 7.69891 7.5 7.5 7.5C7.30109 7.5 7.11032 7.57902 6.96967 7.71967C6.82902 7.86032 6.75 8.05109 6.75 8.25V12.75C6.75 12.9489 6.82902 13.1397 6.96967 13.2803C7.11032 13.421 7.30109 13.5 7.5 13.5ZM15 4.5H12V3.75C12 3.15326 11.7629 2.58097 11.341 2.15901C10.919 1.73705 10.3467 1.5 9.75 1.5H8.25C7.65326 1.5 7.08097 1.73705 6.65901 2.15901C6.23705 2.58097 6 3.15326 6 3.75V4.5H3C2.80109 4.5 2.61032 4.57902 2.46967 4.71967C2.32902 4.86032 2.25 5.05109 2.25 5.25C2.25 5.44891 2.32902 5.63968 2.46967 5.78033C2.61032 5.92098 2.80109 6 3 6H3.75V14.25C3.75 14.8467 3.98705 15.419 4.40901 15.841C4.83097 16.2629 5.40326 16.5 6 16.5H12C12.5967 16.5 13.169 16.2629 13.591 15.841C14.0129 15.419 14.25 14.8467 14.25 14.25V6H15C15.1989 6 15.3897 5.92098 15.5303 5.78033C15.671 5.63968 15.75 5.44891 15.75 5.25C15.75 5.05109 15.671 4.86032 15.5303 4.71967C15.3897 4.57902 15.1989 4.5 15 4.5ZM7.5 3.75C7.5 3.55109 7.57902 3.36032 7.71967 3.21967C7.86032 3.07902 8.05109 3 8.25 3H9.75C9.94891 3 10.1397 3.07902 10.2803 3.21967C10.421 3.36032 10.5 3.55109 10.5 3.75V4.5H7.5V3.75ZM12.75 14.25C12.75 14.4489 12.671 14.6397 12.5303 14.7803C12.3897 14.921 12.1989 15 12 15H6C5.80109 15 5.61032 14.921 5.46967 14.7803C5.32902 14.6397 5.25 14.4489 5.25 14.25V6H12.75V14.25ZM10.5 13.5C10.6989 13.5 10.8897 13.421 11.0303 13.2803C11.171 13.1397 11.25 12.9489 11.25 12.75V8.25C11.25 8.05109 11.171 7.86032 11.0303 7.71967C10.8897 7.57902 10.6989 7.5 10.5 7.5C10.3011 7.5 10.1103 7.57902 9.96967 7.71967C9.82902 7.86032 9.75 8.05109 9.75 8.25V12.75C9.75 12.9489 9.82902 13.1397 9.96967 13.2803C10.1103 13.421 10.3011 13.5 10.5 13.5Z"
              fill="#666666"
            />
          </svg>
        </MyButton>
      </div>
      <div v-else class="floorItem__no-rooms">
        Вы можете
        <span @click.stop="bus.$emit('open:add-room', floor)"
          >Добавить помещение</span
        >
        или
        <span @click.stop="$emit('delete-floor', $event, floor)"
          >Удалить этаж</span
        >
      </div>
    </header>
    <div :style="contentStyle" class="content">
      <table :style="infoStyle" class="w-full flex flex-col">
        <thead
          class="w-full grid grid-cols-[repeat(6,_1fr),_66px] bg-[#F2F3F3] border border-grey-400"
        >
          <th
            class="flex justify-start items-center border-r border-grey-400 font-normal text-sm p-2.5"
          >
            Номер помещения
          </th>
          <th
            class="flex justify-start items-center border-r border-grey-400 font-normal text-sm p-2.5"
          >
            Кол-во комнат
          </th>
          <th
            class="flex justify-start items-center border-r border-grey-400 font-normal text-sm p-2.5"
          >
            Площадь, м2
          </th>
          <th
            class="flex justify-start items-center border-r border-grey-400 font-normal text-sm p-2.5"
          >
            Полная цена, ₽
          </th>
          <th
            class="flex justify-start items-center border-r border-grey-400 font-normal text-sm p-2.5"
          >
            Статус
          </th>
          <th
            class="flex justify-start items-center border-r border-grey-400 font-normal text-sm p-2.5 text-start"
          >
            Особенности планировки
          </th>
          <th class="flex items-cente"></th>
        </thead>
        <tbody class="w-full flex flex-col border border-grey-400 border-t-0">
          <tr
            :draggable="true"
            @dragstart="(e) => dragStartHandler(e, room)"
            @dragleave="(e) => dragEndHandler(e, room.position)"
            @dragend.prevent="(e) => dragEndHandler(e, room.position)"
            @dragover.prevent="(e) => dragOverHandler(e)"
            @drop.prevent="handleFloorDragEndOuter(room.position)"
            class="w-full grid grid-cols-[repeat(6,_1fr),_66px]"
            v-for="room in floor.rooms"
            :key="room.id"
          >
            <td
              class="flex justify-start items-center border-r border-grey-400 font-normal text-sm p-2.5"
            >
              <div style="cursor: move" class="floorItem__dragIcon mr-2">
                <svg
                  width="8"
                  height="12"
                  viewBox="0 0 8 12"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M1.95829 4.83333C1.72755 4.83333 1.50199 4.90176 1.31013 5.02995C1.11827 5.15815 0.968736 5.34036 0.880434 5.55354C0.792131 5.76672 0.769028 6.0013 0.814044 6.22761C0.85906 6.45392 0.970174 6.6618 1.13334 6.82496C1.2965 6.98812 1.50438 7.09923 1.73069 7.14425C1.957 7.18927 2.19158 7.16616 2.40476 7.07786C2.61794 6.98956 2.80015 6.84002 2.92834 6.64817C3.05654 6.45631 3.12496 6.23075 3.12496 6C3.12496 5.69058 3.00204 5.39384 2.78325 5.17504C2.56446 4.95625 2.26771 4.83333 1.95829 4.83333ZM1.95829 8.91667C1.72755 8.91667 1.50199 8.98509 1.31013 9.11329C1.11827 9.24148 0.968736 9.42369 0.880434 9.63687C0.792131 9.85005 0.769028 10.0846 0.814044 10.3109C0.85906 10.5373 0.970174 10.7451 1.13334 10.9083C1.2965 11.0715 1.50438 11.1826 1.73069 11.2276C1.957 11.2726 2.19158 11.2495 2.40476 11.1612C2.61794 11.0729 2.80015 10.9234 2.92834 10.7315C3.05654 10.5396 3.12496 10.3141 3.12496 10.0833C3.12496 9.77391 3.00204 9.47717 2.78325 9.25838C2.56446 9.03958 2.26771 8.91667 1.95829 8.91667ZM6.04163 3.08333C6.27237 3.08333 6.49794 3.01491 6.68979 2.88672C6.88165 2.75852 7.03118 2.57631 7.11949 2.36313C7.20779 2.14995 7.23089 1.91537 7.18588 1.68906C7.14086 1.46275 7.02975 1.25487 6.86658 1.09171C6.70342 0.928548 6.49554 0.817434 6.26923 0.772418C6.04292 0.727402 5.80834 0.750505 5.59516 0.838808C5.38198 0.92711 5.19977 1.07664 5.07158 1.2685C4.94338 1.46036 4.87496 1.68592 4.87496 1.91667C4.87496 2.22609 4.99788 2.52283 5.21667 2.74163C5.43546 2.96042 5.73221 3.08333 6.04163 3.08333ZM1.95829 0.75C1.72755 0.75 1.50199 0.818424 1.31013 0.946619C1.11827 1.07481 0.968736 1.25702 0.880434 1.4702C0.792131 1.68338 0.769028 1.91796 0.814044 2.14427C0.85906 2.37058 0.970174 2.57846 1.13334 2.74163C1.2965 2.90479 1.50438 3.0159 1.73069 3.06092C1.957 3.10593 2.19158 3.08283 2.40476 2.99453C2.61794 2.90622 2.80015 2.75669 2.92834 2.56483C3.05654 2.37298 3.12496 2.14741 3.12496 1.91667C3.12496 1.60725 3.00204 1.3105 2.78325 1.09171C2.56446 0.872917 2.26771 0.75 1.95829 0.75ZM6.04163 8.91667C5.81088 8.91667 5.58532 8.98509 5.39346 9.11329C5.2016 9.24148 5.05207 9.42369 4.96377 9.63687C4.87546 9.85005 4.85236 10.0846 4.89738 10.3109C4.94239 10.5373 5.05351 10.7451 5.21667 10.9083C5.37983 11.0715 5.58771 11.1826 5.81402 11.2276C6.04033 11.2726 6.27491 11.2495 6.48809 11.1612C6.70127 11.0729 6.88348 10.9234 7.01167 10.7315C7.13987 10.5396 7.20829 10.3141 7.20829 10.0833C7.20829 9.77391 7.08538 9.47717 6.86658 9.25838C6.64779 9.03958 6.35105 8.91667 6.04163 8.91667ZM6.04163 4.83333C5.81088 4.83333 5.58532 4.90176 5.39346 5.02995C5.2016 5.15815 5.05207 5.34036 4.96377 5.55354C4.87546 5.76672 4.85236 6.0013 4.89738 6.22761C4.94239 6.45392 5.05351 6.6618 5.21667 6.82496C5.37983 6.98812 5.58771 7.09923 5.81402 7.14425C6.04033 7.18927 6.27491 7.16616 6.48809 7.07786C6.70127 6.98956 6.88348 6.84002 7.01167 6.64817C7.13987 6.45631 7.20829 6.23075 7.20829 6C7.20829 5.69058 7.08538 5.39384 6.86658 5.17504C6.64779 4.95625 6.35105 4.83333 6.04163 4.83333Z"
                    fill="#9E9EA4"
                  />
                </svg>
              </div>
              {{ room_types[room.type] }} №: &nbsp;
              <span>{{ room.number }}</span>
            </td>
            <td
              class="flex justify-start items-center border-r border-grey-400 font-normal text-sm p-2.5"
            >
              <span>{{ room.rooms_count }}</span>
            </td>
            <td
              class="flex justify-start items-center border-r border-grey-400 font-normal text-sm p-2.5"
            >
              <span>{{ room.area }}</span>
            </td>
            <td
              class="flex justify-start items-center border-r border-grey-400 font-normal text-sm p-2.5"
            >
              <span>{{ formatNumber(room.total_amount) }}</span>
            </td>
            <td
              class="flex justify-start items-center border-r border-grey-400 font-normal text-sm p-2.5"
            >
              <span>{{ room.complex_status_info.status_name }}</span>
            </td>
            <td
              class="flex justify-start items-center border-r border-grey-400 font-normal text-sm p-2.5"
            >
              <span>{{ layout_futures[room.layout_feature] }}</span>
            </td>
            <td class="flex items-center font-normal text-sm justify-evenly">
              <!-- copyRoom(room) -->
              <button @click.stop="bus.$emit('open:copy-room', floor, room)">
                <svg
                  width="18"
                  height="18"
                  viewBox="0 0 18 18"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M12 15H6C5.40326 15 4.83097 14.7629 4.40901 14.341C3.98705 13.919 3.75 13.3467 3.75 12.75V5.25C3.75 5.05109 3.67098 4.86032 3.53033 4.71967C3.38968 4.57902 3.19891 4.5 3 4.5C2.80109 4.5 2.61032 4.57902 2.46967 4.71967C2.32902 4.86032 2.25 5.05109 2.25 5.25V12.75C2.25 13.7446 2.64509 14.6984 3.34835 15.4017C4.05161 16.1049 5.00544 16.5 6 16.5H12C12.1989 16.5 12.3897 16.421 12.5303 16.2803C12.671 16.1397 12.75 15.9489 12.75 15.75C12.75 15.5511 12.671 15.3603 12.5303 15.2197C12.3897 15.079 12.1989 15 12 15ZM15.75 6.705C15.7422 6.6361 15.7271 6.56822 15.705 6.5025V6.435C15.6689 6.35788 15.6208 6.287 15.5625 6.225L11.0625 1.725C11.0005 1.66666 10.9296 1.61856 10.8525 1.5825H10.785L10.545 1.5H7.5C6.90326 1.5 6.33097 1.73705 5.90901 2.15901C5.48705 2.58097 5.25 3.15326 5.25 3.75V11.25C5.25 11.8467 5.48705 12.419 5.90901 12.841C6.33097 13.2629 6.90326 13.5 7.5 13.5H13.5C14.0967 13.5 14.669 13.2629 15.091 12.841C15.5129 12.419 15.75 11.8467 15.75 11.25V6.75C15.75 6.75 15.75 6.75 15.75 6.705ZM11.25 4.0575L13.1925 6H12C11.8011 6 11.6103 5.92098 11.4697 5.78033C11.329 5.63968 11.25 5.44891 11.25 5.25V4.0575ZM14.25 11.25C14.25 11.4489 14.171 11.6397 14.0303 11.7803C13.8897 11.921 13.6989 12 13.5 12H7.5C7.30109 12 7.11032 11.921 6.96967 11.7803C6.82902 11.6397 6.75 11.4489 6.75 11.25V3.75C6.75 3.55109 6.82902 3.36032 6.96967 3.21967C7.11032 3.07902 7.30109 3 7.5 3H9.75V5.25C9.75 5.84674 9.98705 6.41903 10.409 6.84099C10.831 7.26295 11.4033 7.5 12 7.5H14.25V11.25Z"
                    fill="#666666"
                  />
                </svg>
              </button>
              <button @click.stop="bus.$emit('open:edit-room', floor, room)">
                <svg
                  width="18"
                  height="18"
                  viewBox="0 0 18 18"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M15.75 8.99995C15.5511 8.99995 15.3603 9.07897 15.2197 9.21962C15.079 9.36028 15 9.55104 15 9.74995V14.25C15 14.4489 14.921 14.6396 14.7803 14.7803C14.6397 14.9209 14.4489 15 14.25 15H3.75C3.55109 15 3.36032 14.9209 3.21967 14.7803C3.07902 14.6396 3 14.4489 3 14.25V3.74995C3 3.55104 3.07902 3.36028 3.21967 3.21962C3.36032 3.07897 3.55109 2.99995 3.75 2.99995H8.25C8.44891 2.99995 8.63968 2.92094 8.78033 2.78028C8.92098 2.63963 9 2.44887 9 2.24995C9 2.05104 8.92098 1.86028 8.78033 1.71962C8.63968 1.57897 8.44891 1.49995 8.25 1.49995H3.75C3.15326 1.49995 2.58097 1.73701 2.15901 2.15896C1.73705 2.58092 1.5 3.15322 1.5 3.74995V14.25C1.5 14.8467 1.73705 15.419 2.15901 15.8409C2.58097 16.2629 3.15326 16.5 3.75 16.5H14.25C14.8467 16.5 15.419 16.2629 15.841 15.8409C16.2629 15.419 16.5 14.8467 16.5 14.25V9.74995C16.5 9.55104 16.421 9.36028 16.2803 9.21962C16.1397 9.07897 15.9489 8.99995 15.75 8.99995ZM4.5 9.56995V12.75C4.5 12.9489 4.57902 13.1396 4.71967 13.2803C4.86032 13.4209 5.05109 13.5 5.25 13.5H8.43C8.5287 13.5005 8.62655 13.4816 8.71793 13.4443C8.80931 13.407 8.89242 13.352 8.9625 13.2825L14.1525 8.08495L16.2825 5.99995C16.3528 5.93023 16.4086 5.84728 16.4467 5.75589C16.4847 5.66449 16.5043 5.56646 16.5043 5.46745C16.5043 5.36845 16.4847 5.27042 16.4467 5.17902C16.4086 5.08763 16.3528 5.00468 16.2825 4.93495L13.1025 1.71745C13.0328 1.64716 12.9498 1.59136 12.8584 1.55329C12.767 1.51521 12.669 1.49561 12.57 1.49561C12.471 1.49561 12.373 1.51521 12.2816 1.55329C12.1902 1.59136 12.1072 1.64716 12.0375 1.71745L9.9225 3.83995L4.7175 9.03745C4.64799 9.10753 4.59299 9.19065 4.55567 9.28202C4.51835 9.3734 4.49943 9.47125 4.5 9.56995ZM12.57 3.30745L14.6925 5.42995L13.6275 6.49495L11.505 4.37245L12.57 3.30745ZM6 9.87745L10.4475 5.42995L12.57 7.55245L8.1225 12H6V9.87745Z"
                    fill="#9E9EA4"
                  />
                </svg>
              </button>
              <button @click.stop="toggle($event, room)">
                <svg
                  width="18"
                  height="18"
                  viewBox="0 0 18 18"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M7.5 13.5C7.69891 13.5 7.88968 13.421 8.03033 13.2803C8.17098 13.1397 8.25 12.9489 8.25 12.75V8.25C8.25 8.05109 8.17098 7.86032 8.03033 7.71967C7.88968 7.57902 7.69891 7.5 7.5 7.5C7.30109 7.5 7.11032 7.57902 6.96967 7.71967C6.82902 7.86032 6.75 8.05109 6.75 8.25V12.75C6.75 12.9489 6.82902 13.1397 6.96967 13.2803C7.11032 13.421 7.30109 13.5 7.5 13.5ZM15 4.5H12V3.75C12 3.15326 11.7629 2.58097 11.341 2.15901C10.919 1.73705 10.3467 1.5 9.75 1.5H8.25C7.65326 1.5 7.08097 1.73705 6.65901 2.15901C6.23705 2.58097 6 3.15326 6 3.75V4.5H3C2.80109 4.5 2.61032 4.57902 2.46967 4.71967C2.32902 4.86032 2.25 5.05109 2.25 5.25C2.25 5.44891 2.32902 5.63968 2.46967 5.78033C2.61032 5.92098 2.80109 6 3 6H3.75V14.25C3.75 14.8467 3.98705 15.419 4.40901 15.841C4.83097 16.2629 5.40326 16.5 6 16.5H12C12.5967 16.5 13.169 16.2629 13.591 15.841C14.0129 15.419 14.25 14.8467 14.25 14.25V6H15C15.1989 6 15.3897 5.92098 15.5303 5.78033C15.671 5.63968 15.75 5.44891 15.75 5.25C15.75 5.05109 15.671 4.86032 15.5303 4.71967C15.3897 4.57902 15.1989 4.5 15 4.5ZM7.5 3.75C7.5 3.55109 7.57902 3.36032 7.71967 3.21967C7.86032 3.07902 8.05109 3 8.25 3H9.75C9.94891 3 10.1397 3.07902 10.2803 3.21967C10.421 3.36032 10.5 3.55109 10.5 3.75V4.5H7.5V3.75ZM12.75 14.25C12.75 14.4489 12.671 14.6397 12.5303 14.7803C12.3897 14.921 12.1989 15 12 15H6C5.80109 15 5.61032 14.921 5.46967 14.7803C5.32902 14.6397 5.25 14.4489 5.25 14.25V6H12.75V14.25ZM10.5 13.5C10.6989 13.5 10.8897 13.421 11.0303 13.2803C11.171 13.1397 11.25 12.9489 11.25 12.75V8.25C11.25 8.05109 11.171 7.86032 11.0303 7.71967C10.8897 7.57902 10.6989 7.5 10.5 7.5C10.3011 7.5 10.1103 7.57902 9.96967 7.71967C9.82902 7.86032 9.75 8.05109 9.75 8.25V12.75C9.75 12.9489 9.82902 13.1397 9.96967 13.2803C10.1103 13.421 10.3011 13.5 10.5 13.5Z"
                    fill="#9E9EA4"
                  />
                </svg>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </article>
  <OverlayPanel unstyled="true" ref="op" class="planEditWindow3dOverlay">
    <h3 class="popover-title">Удалить помещениe?</h3>
    <div class="popover-content">
      <p class="confirmation-content" style="display: none"></p>
      <div class="confirmation-buttons text-center">
        <div
          style="display: flex; justify-content: center"
          class="overlay-custom-btn-group"
        >
          <button
            @click="handleDeleteRoom()"
            style="display: flex; align-items: center"
            class="overlay-custom-btn overlay-custom-btn-xs overlay-custom-btn-success"
            data-apply="confirmation"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              x="0px"
              y="0px"
              width="13"
              height="13"
              viewBox="0 0 26 26"
            >
              <path
                fill="white"
                d="M 22.566406 4.730469 L 20.773438 3.511719 C 20.277344 3.175781 19.597656 3.304688 19.265625 3.796875 L 10.476563 16.757813 L 6.4375 12.71875 C 6.015625 12.296875 5.328125 12.296875 4.90625 12.71875 L 3.371094 14.253906 C 2.949219 14.675781 2.949219 15.363281 3.371094 15.789063 L 9.582031 22 C 9.929688 22.347656 10.476563 22.613281 10.96875 22.613281 C 11.460938 22.613281 11.957031 22.304688 12.277344 21.839844 L 22.855469 6.234375 C 23.191406 5.742188 23.0625 5.066406 22.566406 4.730469 Z"
              ></path>
            </svg>
            Да
          </button>
          <button
            @click="toggle"
            style="display: flex; align-items: center"
            class="overlay-custom-btn overlay-custom-btn-xs overlay-custom-btn-danger"
            data-dismiss="confirmation"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              x="0px"
              y="0px"
              width="13"
              height="13"
              viewBox="0 0 26 26"
            >
              <path
                fill="white"
                d="M 21.734375 19.640625 L 19.636719 21.734375 C 19.253906 22.121094 18.628906 22.121094 18.242188 21.734375 L 13 16.496094 L 7.761719 21.734375 C 7.375 22.121094 6.746094 22.121094 6.363281 21.734375 L 4.265625 19.640625 C 3.878906 19.253906 3.878906 18.628906 4.265625 18.242188 L 9.503906 13 L 4.265625 7.761719 C 3.882813 7.371094 3.882813 6.742188 4.265625 6.363281 L 6.363281 4.265625 C 6.746094 3.878906 7.375 3.878906 7.761719 4.265625 L 13 9.507813 L 18.242188 4.265625 C 18.628906 3.878906 19.257813 3.878906 19.636719 4.265625 L 21.734375 6.359375 C 22.121094 6.746094 22.121094 7.375 21.738281 7.761719 L 16.496094 13 L 21.734375 18.242188 C 22.121094 18.628906 22.121094 19.253906 21.734375 19.640625 Z"
              ></path>
            </svg>
            Нет
          </button>
        </div>
      </div>
    </div>
  </OverlayPanel>
</template>

<script>
import MyButton from "@/shared/UI/MyButton.vue";
import RadioButton from "primevue/radiobutton";
import { ref, computed } from "vue";
import bus from "@/eventBus.js";
import { formatNumber, layout_futures, room_types } from "@/shared/utils/util";
import OverlayPanel from "primevue/overlaypanel";
import api from "@/shared/api";

export default {
  name: "AccordionItem",
  components: { RadioButton, MyButton, OverlayPanel },
  props: {
    floor: Object,
    index: Number,
  },
  setup(props) {
    const expanded = ref(false);
    const dragRoom = ref(1);
    const contentStyle = computed(() => {
      return { "max-height": expanded.value ? `unset` : 0 };
    });

    const infoStyle = computed(() => {
      return { display: expanded.value ? "block" : "none" };
    });

    const roomToDelete = ref();

    return {
      expanded,
      contentStyle,
      infoStyle,
      bus,
      layout_futures,
      room_types,
      dragRoom,
      roomToDelete,
      formatNumber
    };
  },
  methods: {
    async changeFloorAlignment(floor_id, alignment) {
      await api.updateFloor(floor_id, { alignment })
    },
    changeAlignment(floor, alignment) {
      this.changeFloorAlignment(floor.id, alignment).then(() => {
        floor.alignment = alignment;
      });
    },
    async deleteRoom(room) {
      return await api.deleteRoom(room.id)
        .then(() => {
          this.floor.rooms = this.floor.rooms.filter((_room) => {
            return _room.id !== room.id;
          });

          if (!this.floor.rooms.length) {
            this.expanded = false;
          }
        })
    },
    toggleExpanded() {
      if (this.floor.rooms.length) {
        this.expanded = !this.expanded;
      }
    },
    dragStartHandler(e, room) {
      if (e.dataTransfer) e.dataTransfer.dropEffect = "move";
      this.dragRoom = room;
    },
    dragEndHandler(e) {
      e.target.style.background = "#ffffff";
    },
    dragOverHandler(e) {
      e.target.style.background = "#F2EED6";
    },
    handleFloorDragEndOuter(position) {
      if (this.dragRoom.position > 0) {
        this.floor.rooms = this.floor.rooms
          .map((room) => {
            if (room.position === position) {
              return { ...room, position: this.dragRoom.position };
            }
            if (room.position === this.dragRoom.position) {
              return { ...room, position };
            }
            return room;
          })
          .sort((a, b) =>
            a.position > b.position ? 1 : -1
          );
      }

      event.target.style.background = "#fff";
    },
    updateRoom(room) {
      return api.updateRoom(room)
    },
    toggle(event, room) {
      if (room) {
        this.roomToDelete = room;
      }
      this.$refs.op.toggle(event);
    },
    handleDeleteRoom() {
      this.deleteRoom(this.roomToDelete);
      this.toggle();
    },
  },
  watch: {
    'floor.rooms': function (value) {
      value.forEach((room, index) => {
        this.updateRoom({ position: index + 1, id: room.id });
      });
    },
  },
};
</script>

<style scoped lang="scss">
.accordion {
  border-radius: var(--radius);
  border: 1px solid #d4d6da;
}
header {
  padding: 20px;
}
.accordion header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.accordion-title {
  margin-left: 10px;

  &.blue-color {
    div {
      color: #1d77d8;

      svg {
        fill: #1d77d8;
      }
    }
  }
  div {
    width: max-content;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
  }
}

.content {
  max-height: 0;
  transition: max-height 0.2s ease-out;
}
.info {
  z-index: -1;
  opacity: 0;
  transition: opacity 0.2s ease-out;
}

.floorItem__addRoom {
  margin: 0 15px;
}

.floorItem__alignment {
  color: #868a95 !important;
  font-size: 15px;
}

.floorItem__no-rooms {
  font-size: 15px;
  span {
    cursor: pointer;
    color: #519ef3;
  }
}
</style>
